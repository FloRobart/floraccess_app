name: Check package version on PR to master

on:
  pull_request:
    branches:
      - master
    types: [opened, synchronize, reopened]

jobs:
  check-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get current app version from pubspec
        id: pkg
        run: |
          version=$(grep '^version:' pubspec.yaml | head -n1 | sed -E 's/^version:[[:space:]]*([0-9]+\.[0-9]+\.[0-9]+).*$/\1/')
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Get latest tag
        id: tag
        run: |
          latest_tag=$(git tag --sort=-creatordate | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -n 1)
          echo "latest_tag=$latest_tag" >> $GITHUB_OUTPUT
          if [ -z "$latest_tag" ]; then
            echo "Aucun tag trouvé, la vérification de version est ignorée."
          fi

      - name: Compare app version with latest tag
        run: |
          pkg_version=${{ steps.pkg.outputs.version }}
          latest_tag=${{ steps.tag.outputs.latest_tag }}
          if [ -z "$latest_tag" ]; then
            echo "Aucun tag de version trouvé, la vérification est ignorée."
            exit 0
          fi
          tag_version=${latest_tag#v}
          if [ "$pkg_version" = "$tag_version" ]; then
            echo "❌ La version du pubspec.yaml ($pkg_version) n'a pas été modifiée depuis le dernier tag ($latest_tag). Veuillez incrémenter la version avant de merger."
            exit 1
          else
            echo "✅ La version du pubspec.yaml ($pkg_version) est différente du dernier tag ($latest_tag)."
          fi
